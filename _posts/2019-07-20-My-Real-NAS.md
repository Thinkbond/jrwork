---
layout: post
title:  简单的 NAS 不简单
tags:   群晖 NAS
date:   2019-07-20 14:36:00
categories: [数字生活] 

---

身处信息时代，家庭数据管理的需求一直都在，直到今年六月底我还在用着搭建了多年的「路由器 + 硬盘」NAS 方案。一次偶然的机会，获得一台入门级群晖 NAS，我想，是时候给家庭数据「吃顿好的」了。

印象中 NAS 属于「傻瓜化」操作的硬件，实际上手体验后发现，即使群晖这种以易用著称的 NAS 也需要仔细研究设置，才能发挥其最大价值。经过接近一周时间的摸索，最终应用场景如下图所示：

![img](http://ww3.sinaimg.cn/large/006tNc79ly1g56aqwhvodj312u0u046r.jpg)

## 1 NAS 三大应用场景：

### 1-1 文件备份

文件备份是 NAS 的基础功能，主要备份类型有：

- **相机照片备份**：拍照归来，取出相机的 SD 卡，插入 NAS 前面板的 SD 卡槽，SDCopy（仅部分型号支持）会自动备份照片到指定位置然后弹出 SD 并用嘀声提醒备份成功，等有空时再去挑选整理照片。
- **NAS 数据冷备**：NAS 中的硬盘在长期开机使用过程中，难免会有损耗，为确保数据安全性，还需要定期进行冷备。只需定期将移动硬盘插入 NAS 前面板 USB 口，USBCopy （仅部分型号支持）会自动导出之前预设的文件/目录到移动硬盘中并在完成后弹出。
- **手机/平板照片/文件备份**：备份手机最烦了，有了 DS Photo 就可以非常方便的将家人所有的手机/平板拍的照片及时上传至 NAS；还可以使用 DS File 读取/存入文件。

### 1-2 系统备份

相信无论 macOS 用户还是 Windows 用户都会经历过系统重装的痛苦，所以系统备份也是非常重要的一件事。由于家里的 PC 很少使用并未安装多少应用，而且自从升级 Windows 10 之后，重装系统（不安装过多应用的前提下）已经轻松许多了，我这里就没有用 NAS 来备份 PC。

- **Time Machine（时间机器）**：在 NAS 新建了 Mac 专用账户，分配了 256GB 空间用于 Time Machine 备份，省心。
- **NAS 系统设置及套件数据备份**：使用 Hyper Backup 组件定期备份 NAS 的设置项及套件数据，确保 NAS 损毁时可以无损迁移到新 NAS 中。

### 1-3 同步与应用

为确保经常使用的文件能够在多个终端同步（比如 MacBook 与 家里的 PC），我们需要一个「同步」盘，同时，为避免隐私信息泄露，网络中的同步盘还是少用为妙。

- **文件同步（含版本控制）**：使用 NAS 的 Cloud Station Server 组件，统一管理所有终端中的文件状态，同时启用尽可能多的版本备份，确保文件的安全。当然，为了安全性，未打开 NAS 的外网访问功能，算是稍微牺牲了同步及时性。 
- **照片浏览**：一家人坐在电视机前观看旅行的照片是件很幸福的事。因此，千万不要错过 NAS 提供的 Photo Station 服务。
- **音乐/视频播放**：手机/电脑容量往往有限，如果想随时播放之前辛苦收集的存货，可以用 NAS 提供的 Audio Station 服务收听以及 Kodi（电视或电脑端）播放。

注：以上场景并未涵盖 NAS 所有功能， 入门级 NAS 性能不允许，个人也没有相关需求。

## 2 NAS 与「路由器+硬盘」方案对比

鉴于之前写过一篇 [DIY「NAS」](https://sspai.com/post/53166)的文章，当时是基于有限条件下做出的次优选择，既然现在有 NAS 了，简单做下对比，供有需求的朋友参考。

### 2-1 文件传输速度

| 传输方式                | NAS            | 路由器+硬盘   |
| ----------------------- | -------------- | ------------- |
| 内部对拷（双盘位）      | > 75MB/s       | N/A           |
| 局域网复制/写入（有线） | 30MB/s～50MB/s | 5MB/s～10MB/s |
| 局域网复制/写入（无线） | 7~30MB/s       | < 5MB/s       |

注：以上测试均基于本人使用的旧款入门级 NAS（ SATAII）以及普通千兆路由器的**大文件**传输对比，与局域网环境条件（是否千兆等）、硬盘规格、分区格式、Raid 模式均有关系，本表数据仅供参考，如果你使用新款 NAS ，差距会更大。

因此，在文件传输速度方面，NAS 完胜。

### 2-2 使用便利性

之前使用路由器+硬盘方案时，备份、同步功能均需要开启电脑，冷备更是需要将移动硬盘（3.5’）从盒子中取出放入硬盘座，然后连接入 PC ，利用 Goodsync 同步文件，由于是通过网络传输，且路由器自带的 USB3.0 接口速度特别慢，文件传输效率奇低。每次周期性冷备时要连接多根线缆，非常繁琐。

因此，在使用便利性方面，NAS 完胜。

### 2-3 功能及数据安全性

路由器+硬盘方案只能提供基本的 SMB、FTP 等**文件共享服务**，而 NAS 除了支持更多文件共享服务以外，还能够同时兼顾自我数据保护备份、同步和各种娱乐服务等功能。

另外，由于路由器仅直连一块硬盘，只能靠开启 PC 进行热备或使用移动硬盘备份，且没有版本控制，也不能在很方便的情况下实现多个副本备份。而 NAS 除了可以组成 Raid （软），还能通过各种组件完成自动内部热备以及插入移动硬盘后的自动导入导出（冷备）。在方便操作的前提下实现更完善的数据备份。

因此，在功能实现的丰富度以及数据安全性方面，NAS 完胜。综合以上几大因素，NAS 均比路由器+硬盘的方案更优，那么劣势只剩下一个——贵。

## 3 NAS 的定位与选择

一家公司产品的路线规划再清晰也会遇到选择困难的顾客。例如 Mac 产品线，身边总会有人纠结很久，到底要买「nMB」、「MBA」还是「MBP」。NAS 产品也不例外，所以在开始具体操作前，我们先来探讨一下有关群晖 NAS 的选择。个人把它定位为家庭数据中心，选购前需要考虑清楚「数据保护」和「成本投入」这两个最关键的因素，然后根据个人需求找到那个投入最小收益最大的平衡点。

### 3-1 风险评估

简言之，就是在配置一套 NAS 前，你需要想清楚，你对文件丢失的容忍度是多少？

相信对于大多数人来说，家庭照片和工作文档是最重要的数据，无法接受其损坏或丢失；相对而言，对于临时下载的视频、软件等内容就变得可有可无了。以此为原则的话，我们其实并不需要太大的硬盘空间，也就是说即使保留多个备份也不会需要超（tài）大（duō）硬盘（qián）。无论你认为哪些文件属于重要数据，都需要一种科学的备份方案来保障，一旦文件发生丢失或损坏，可以随时从备份中恢复。「3-2-1 原则」是一种久经考验且直观易行的文件备份方法，具体规则如下：

![img](http://ww1.sinaimg.cn/large/006tNc79ly1g56aqofq41j30gu08sjs5.jpg)

- **3**：存储 3 份完整的文件，一份原件加上两份拷贝。
- **2**：将文件至少保存在 2 种不同的介质上（比如两块硬盘，注意尽量避免使用同一批次买入的硬盘，防止同时出现故障，虽然几率较低）。
- **1**：将 1 份拷贝保存在异地，比如办公室、值得信赖的朋友家等。

### 3-2 成本考量

NAS 的成本主要来自 NAS 本身以及用于存放数据的硬盘，还有后续使用、维护所投入的时间精力成本。群晖 NAS 本身价格不低，最基础的两盘位也要上千元，若想提高数据安全性还需要配备质量过硬的硬盘（虽然这年头难以找到可靠的硬盘了），所以个人认为最基本的 NAS 硬件购入成本约 3000 元，包括一台 NAS 主机（如 DS 218j）和两块 4T NAS 硬盘。这套系统可以保障你的数据的基本安全，可以应付基本的文件共享功能需求。如果在此基础上还想用 Docker、Video Station 等运算量相对较大的服务，建议选择 X86 架构（如 DS 218+），这样总成本预计约 5000 元。如果需要组成 Raid 5 或 Raid 10 进一步提升数据安全性和可用性，需要更大的容量，那请选择四盘位及以上型号，搭配 8TB 及以上硬盘，成本预计高于 10000 元。

### 3-3 NAS 推荐选项

- **买哪个型号**？以群晖为例，虽然它有着众多型号，但在我眼里只有两种：X86 和 ARM （指 CPU），因为直接决定了你「能」用它做什么。如果你预算充足，建议直接选主打型号，例如 DS 918+ 或以上；如果你预算有限但还需要 Docker 或各种资源消耗较大的服务，那么也请选择配备 X86 CPU 的型号；如果你像我一样，主要使用 NAS 的文件共享服务，不需要过多计算能力，选择入门型号（两盘位及以上）即可，毕竟，买了 NAS 还要配足硬盘哦。如何分辨某个型号是 X86 还是 ARM ？有个比较简单的方式，查看官方规格表中内存是否有扩充能力，如果能扩展内存，一定是 X86 架构。
- **硬盘工作模式选 Raid 还是 Basic**？基于之前工作经验，群晖之类的 NAS 所带的软 Raid 可靠性及性能还是有些差强人意。如果你的群晖是**两盘位**，不建议使用 Raid，除非你不考虑数据安全性用 Raid 0。Raid 1 的最大价值仅仅是提高 NAS 的可用性（某块硬盘出现故障时，仍能访问），但对数据安全或硬盘寿命并没有比单硬盘更高多少。况且，一旦某块硬盘损毁，更换新盘重建的时长和数据写入量是非常磨人的。而使用两块独立硬盘（Basic 模式）同样可以通过自带 Hyper Backup 组件设定自动互相备份，使数据在 NAS 中有两份同样拷贝，从而提高数据安全性。
- **文件系统的选择 Btrfs 还是 ext4**？Btrfs 是新的文件系统，支持快照等功能，备份时的空间需求较小，但性能和兼容性在一定程度上略低于 ext4，具体选择哪种文件系统，还是看需求，是否有更加精细的备份需要，否则就选择 ext4。我的 NAS 比较老，所以只有 ext4 可选。
- **开启休眠还是 「7×24hrs」**？关于是否休眠的选择本不会那么纠结，但搜索一下就会知道，不知从何时起，不少群晖用户反应自己的内置硬盘总会被无故唤醒，启停次数大量增加，据说这样对硬盘有损耗。所以，才会有人宁愿 24 小时开机。经过各种尝试（下文细说），找到了有效的办法避免硬盘被无故唤醒，每天都能让 NAS 睡个饱觉，降低能耗的同时也保护了硬盘。
- **要静音还是清凉**？默认系统设置风扇模式为静音，也就是低转速模式。夏天在空调环境下不存在什么问题，但作为家用，一般不会 24 小时开空调，此时如果不增强散热效果，对硬盘会有一定损伤。所以我的做法是，在夏季高温时，风扇设置为「低温」工作模式（工作时依然很安静），其余时间改为「静音」模式。
- **开不开外网访问**？群晖的一个特色功能就是能够通过外网访问家中的数据，简单的做法就是开启 **QuickConnect** 或者 DDNS ，但一般情况下访问速度感人，而且把个人的数据直接连接到互联网还是不能让人完全放心。所以，开不开外网访问功能，取决于你是否更看重随时访问自己的数据。

## 4 NAS 的使用逻辑

### 4-1 准备工作

#### 4-1-1 梳理文件层级

合理调配资源，把好钢（空间）用在刀刃上，是我规划 NAS 空间的初衷。下图是我按照文件重要程度（因人而异，土豪完全不必在意）将文件划分为三个层级，并依据「3-2-1」原则，对重要文件的存放副本进行合理划分：

![img](http://ww1.sinaimg.cn/large/006tNc79ly1g56aqst3mej310u0o0ths.jpg)

- ⭐️⭐️⭐️：对我极重要的数据，采用「3-2-1」原则冗余设计。例如，文档原始版本放在 NAS 中的主力 1 号存储空间（盘）中，使用 Cloud Station Server 确保「MacBook-PC-NAS」三者间（在家）随时同步保持版本一致，然后使用 Hyper Backup 设定一个周期任务将存储空间 1 中的文档备份至存储空间 2 中，作为经常修订的数据，保持版本的可追溯性也很重要，所以在版本控制选项中设定了保留 64 个版本。然后定期通过NAS USB 端口自动备份至移动硬盘中，对「文档」、「照片」来说，定期备份至两块移动硬盘中，分别存放在家中和办公室。这样，「文档」、「照片」就拥有了超过 4 份拷贝，极大增强了重要数据的抗风险能力。
- ⭐️⭐️：一般数据，相对有用，但万一丢了也不心疼。比如购买的视频教程，当初为了方便离线观看全部下载下来，一旦丢失了还是可以重新下载。对于这类数据，只需满足基本的「3-2-1」原则即可，避免占用过多空间。
- ⭐️：可有可无的数据：非常容易在线获取的内容，占用空间缺比较大，因此，我只保留 1 个拷贝在剩余空间较多的存储空间 2 中，设置好 NFS/SMB 文件共享服务，可以随时使用电视观看，使用电脑打开即可。

#### 4-1-2 DSM 设置

限于篇幅，如何安装硬盘以及 DSM 系统不是本文重点，官方网站或手册中就有简单易懂的说明，在这里仅列出作为**入门级** NAS 比较有意义的一些自定义设置项供大家参考，高端 NAS 会有更多玩法，但不包含在本文中。（我也想啊～）

**注：建议在改动系统设置前，强烈建议在控制面板—>更新和还原—>系统设置备份中备份一下，避免误操作导致问题发生。**

- **系统设置-电源选项**：如前文所述，经过几番折腾，终于搞定硬盘无故唤醒的问题，现在就把解决方式分享给大家。如果按照如下设置仍无法解决，请参考[官方知识库](https://www.synology.com/zh-cn/knowledgebase/DSM/help/DSM/AdminCenter/system_hardware_hibernation_qoriq)逐一排查解决。

  1. 控制面板 —>安全性—>防火墙：启用并编辑防火墙规则，并按照下图设置，作用是阻止**路由器**扫描终端时把休眠中的 NAS 唤醒。

     ![img](http://ww4.sinaimg.cn/large/006tNc79ly1g56asc2xl0j316r0u0wgy.jpg)

     把不需要的服务打上勾，其中来源 IP 是本地路由器的局域网地址。

     ![img](http://ww1.sinaimg.cn/large/006tNc79ly1g56aqpulyej30w60tyq7h.jpg)

     确定后在「操作」选择「拒绝」，最后别忘把「若上述规则皆不符合时：」设置为「允许访问」。

  2. 注意排查计划任务不要设置的过于频繁。

  3. 启动异常断电恢复后自动开机，减少人工操作，保持服务可用。

     ![img](http://ww2.sinaimg.cn/large/006tNc79ly1g56as6wo22j30pm0b8401.jpg)

  4. 开启休眠，并开启「忽略 Windows 资源管理器广播包」

     ![img](http://ww4.sinaimg.cn/large/006tNc79ly1g56aqrslvwj30xy0j8juv.jpg)

- **系统设置-共享权限设置**：

  如果想让电视随时播放 NAS 中的视频，需要注意开启 NFS 共享，同时为共享文件夹设置如下权限，避免电视端无法访问。

  ![img](http://ww3.sinaimg.cn/large/006tNc79ly1g56aqitvl7j30qy0h6mzo.jpg)

  另外，由于给予了读写权限，为增强安全性，建议为电视、MacBook、PC 等终端设置独立的账户。

  ![img](http://ww2.sinaimg.cn/large/006tNc79ly1g56aqnnnmyj30ug0fkq4a.jpg)

- **Photo Station Uploader**：此项为「弱鸡」NAS 专用，正常备份手机照片我们完全可以使用 DS Photo 或着 Moments 自动备份，但对于 ARM 架构 NAS 来说，你备份几千张，它为了能在我们使用 DS Photo 浏览照片时能看到缩略图，会让 CPU 接近满负荷运转**数天**，得不偿失。因此，我们需要做如下两处设置，首先，降低缩略图品质为「一般」，通过在「媒体索引文件夹」排除视频文件夹，关闭对手机拍摄视频的自动转换功能（效率更低）。

  ![img](http://ww3.sinaimg.cn/large/006tNc79ly1g56aqktr0nj30ug0qugpp.jpg)

  使用传统方式批量上传照片，而不是通过 DS Photo 自动备份，因为自动备份时会使用 NAS 的 CPU 转换缩略图。而通过群晖提供的 Photo Station Uploader 可以在上传时借用电脑的 CPU 进行转换，速度极快。

  ![img](http://ww1.sinaimg.cn/large/006tNc79ly1g56aqlsxbuj30z40r6k25.jpg)

- Cloud Station Driver：像流行的网盘一样，Cloud Station Driver 也可以设置选择性同步，建议对于大型数据库关闭同步功能，一是避免数据库内文件命名不符合通用规则导致同步出错，而是避免带来流量压力。

  ![img](http://ww3.sinaimg.cn/large/006tNc79ly1g56arw7x8lj30ur0u0gvh.jpg)

  另外，还可以设置一些高级选项，让同步过程更符合需要。

  ![img](http://ww3.sinaimg.cn/large/006tNc79ly1g56aqpeoajj30iq0gidie.jpg)

- Hyper Backup：这是群晖 NAS 的经典套件，具有非常强大的备份功能，正是通过它与  USB Copy 功能配合才真正实现了 「3-2-1」备份原则。以我目前使用的内容为例向大家展示一下它的不同备份策略：

  ![img](http://ww3.sinaimg.cn/large/006tNc79ly1g56aqjs8j2j31io0modjn.jpg)

  1. 首先是 1 比 1 拷贝功能，我用来把 NAS 的存储空间 1 中的两星级文件定时备份到存储空间 2 中。

  ![img](http://ww1.sinaimg.cn/large/006tNc79ly1g56aqxfv1hj30qa0jaq55.jpg)

  1. 对于文档使用增量备份，同时保留 64 个版本。

  ![img](http://ww3.sinaimg.cn/large/006tNc79ly1g56aqqso7jj31hk0pojvj.jpg)

  ![img](http://ww3.sinaimg.cn/large/006tNc79ly1g56aqhxe71j311m0o0juh.jpg)

- USB Copy：本功能是我使用群晖 NAS 的最大惊喜发现，让冷备变得非常轻松惬意。以下设置仅需操作一次：

  1. **移动硬盘准备工作**

     由于我设置的文件夹数较多，但 USB 设备上的一个分区只能支持一个复制任务。因此，我需要为每个文件夹在移动硬盘中划分一个分区，这就需要综合考虑 4-1 中对文件层次的规划，分配足够的容量，避免后期调整时麻烦。下图是分区完毕后，挂载到 NAS 中，使用 File Station 查看的两块移动硬盘分区情况：

     ![img](http://ww4.sinaimg.cn/large/006tNc79ly1g56aqtnndsj309q0bgaah.jpg)

     请牢记分区与文件夹的对应顺序，下一步就会用到。

  2. **触发动作设置**

     下面开始为每个需要冷备的文件夹设置 USB Copy 参数

     ![img](http://ww2.sinaimg.cn/large/006tNc79ly1g56aqmq13kj31ds0t4gqj.jpg)

     以移动硬盘 2 为例（对应上图的文档备份、存档备份、照片备份三个任务），首先将移动硬盘 2 插入 NAS 的 USB 端口，打开 USB Copy 组件，点左下角加号新增一个任务，分别选择备份文件夹和移动硬盘对应分区。然后选择复制模式：

     ![img](http://ww2.sinaimg.cn/large/006tNc79ly1g56aqunoskj30yi0qs445.jpg)

     ![img](http://ww4.sinaimg.cn/large/006tNc79ly1g56aqvkdrmj30wu0fk41c.jpg)

     ![img](http://ww4.sinaimg.cn/large/006tNc79ly1g56arg6l3xj30wu0b2q4t.jpg)

  3. **批量顺序任务执行**

     对于多个分区的情况，可以通过简单设置实现插入移动硬盘自动开始逐个分区复制，全部任务完成后自动弹出移动硬盘并使用声音提醒，此时只需拔出移动硬盘就完成了所有备份任务，不能更轻松！

     在第一个分区的复制任务设置中打开「插入 USB/SD 存储设备时，立即复制数据」

     ![img](http://ww3.sinaimg.cn/large/006tNc79ly1g56arbznz0j30na08y75k.jpg)

     在最后一个分区的复制任务中打开「复制完成后退出 USB/SD 存储设备」

     ![img](http://ww2.sinaimg.cn/large/006tNc79ly1g56aqhffs4j30wu0da414.jpg)

     即可实现批量排队执行任务的效果：

     ![img](http://ww1.sinaimg.cn/large/006tNc79ly1g56aqie2naj313c0tcwjc.jpg)

     至此，所有重要的设置均已完成，可以一劳永逸地享受 NAS 带来的便利了！

### 4-2 使用与维护

- **使用**：在 MacBook、PC、手机、电视中安装必要的应用后即可随心使用 NAS 的各项功能；
- **周期冷备**：我用 iPhone 中的 Due 设置了周期提醒，收到提醒后，拿出所有移动硬盘，依次插入 NAS USB 端口，随着嘀的一声响，系统开始自动备份，再听到嘀声就可以拔出移动硬盘了。然后插入第二块、第三块移动硬盘完成所有冷备任务。
- **故障修复**：做了那么多准备工作，根本目的还是希望能够在数据损坏或丢失后迅速找回，所以一旦发现某个文件有问题，可以优先使用 NAS 中的第二块硬盘（存储空间 2）恢复该文件（使用 File Station 或 Hyper Backup），因为往往存储空间 2 中的数据与原始文件最接近且有多个版本。万一不能恢复，再去找出冷备的移动硬盘，手动恢复该文件。如果 NAS 主机本身出故障无法运行了，应该第一时间设法保护好硬盘，不要轻易修改硬盘中的数据。若确认 NAS 无法启动，可将其中一块硬盘拆下用硬盘盒挂载到 Linux 系统环境下恢复其中的数据（这就是选用 ext 4 文件格式的好处）。

### 4-3 注意事项

- 对于新款非 ARM 版群晖用户，推荐使用 [Moments](https://www.synology.cn/zh-cn/dsm/packages/SynologyMoments) 代替 Photo Station；使用 [Synology Drive Server](https://www.synology.cn/zh-cn/dsm/packages/SynologyDrive) 代替 Cloud Station Server；使用 [Active Backup for Business](https://www.synology.cn/zh-cn/dsm/packages/ActiveBackup) 备份 PC 系统（功能类似时间机器）。
- 因资源有限，本文未针对 NAS 的部分高级应用进行介绍，比如 NAS 间数据迁移、SSD 缓存、Docker 应用等。
- 多看 DSM 系统自带帮助系统和官网知识库，你会了解更多。

*注：文中图示中部分图标来自Iconfont-阿里巴巴矢量图标库，感谢作者！*